server:
  port: 8092

spring:
  application:
    name: pressdefectmonitoring

  profiles:
    active: default

---
# ========================================
# DEFAULT PROFILE (ë¡œì»¬ ê°œë°œí™˜ê²½)
# ========================================
spring:
  config:
    activate:
      on-profile: default

  # PostgreSQL ë¡œì»¬ ì—°ê²° ì„¤ì •
  datasource:
    url: jdbc:postgresql://localhost:5432/smartfactory
    username: postgres
    password: password
    driver-class-name: org.postgresql.Driver
    hikari:
      connection-timeout: 20000
      maximum-pool-size: 10
      minimum-idle: 5
      idle-timeout: 300000
      max-lifetime: 1200000
      auto-commit: false

  # JPA ì„¤ì •
  jpa:
    hibernate:
      ddl-auto: update
      naming:
        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
        implicit-strategy: org.hibernate.boot.model.naming.ImplicitNamingStrategyLegacyHbmImpl
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        show_sql: true
        format_sql: true
        use_sql_comments: true
        jdbc:
          lob:
            non_contextual_creation: true
        temp:
          use_jdbc_metadata_defaults: false
    show-sql: true
    open-in-view: false

  # íŠ¸ëœì­ì…˜ ì„¤ì •
  transaction:
    rollback-on-commit-failure: true

  # Kafka ì„¤ì • (ë¡œì»¬) - Spring Cloud Stream 4.x ë°©ì‹
  cloud:
    stream:
      # í•¨ìˆ˜í˜• ë°”ì¸ë”© ì„¤ì • - ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ì²˜ë¦¬ í•¨ìˆ˜ë“¤ ì¶”ê°€
      function:
        definition: rawDataOut;defectDataOut # eventIn ì œê±°
      kafka:
        binder:
          brokers: localhost:9092
          auto-create-topics: true
          auto-add-partitions: true
          configuration:
            max.request.size: 10485760  # 10MB
            buffer.memory: 67108864     # 64MB
        bindings:
          rawDataOut-out-0:
            producer:
              configuration:
                max.request.size: 10485760
          defectDataOut-out-0:
            producer:
              configuration:
                max.request.size: 10485760
        streams:
          binder:
            configuration:
              default:
                key:
                  serde: org.apache.kafka.common.serialization.Serdes$StringSerde
                value:
                  serde: org.apache.kafka.common.serialization.Serdes$StringSerde
              commit:
                interval:
                  ms: 1000
      bindings:
        # ê¸°ì¡´ ì´ë²¤íŠ¸ ìˆ˜ì‹  (IssueSolved ë“±)
        eventIn-in-0:
          destination: carsmartfactory
          group: pressdefectmonitoring
          contentType: application/json
          consumer:
            max-attempts: 3
            back-off-initial-interval: 1000
            
        # ê¸°ì¡´ ì´ë²¤íŠ¸ ë°œí–‰
        eventOut-out-0:
          destination: carsmartfactory
          contentType: application/json
          producer:
            partition-count: 3
            
        # ğŸ†• ìƒˆë¡œìš´ í† í”½ A: ì›ì‹œ ë°ì´í„° ìˆ˜ì‹  ì´ë²¤íŠ¸ ë°œí–‰
        rawDataOut-out-0:
          destination: raw-data-received
          contentType: application/json
          producer:
            partition-count: 3
            
        # ğŸ†• ìƒˆë¡œìš´ í† í”½ B: ê²°í•¨ íƒì§€ ê²°ê³¼ ì´ë²¤íŠ¸ ë°œí–‰  
        defectDataOut-out-0:
          destination: defect-data-detected
          contentType: application/json
          producer:
            partition-count: 3

  # Security ì„¤ì •
  security:
    user:
      name: admin
      password: admin123
      roles: ADMIN

# ì„œë²„ í¬íŠ¸ (ë¡œì»¬ ê°œë°œì‹œ) - 8087 â†’ 8092ë¡œ ë³€ê²½
server:
  port: 8092

# ë¡œê¹… ì„¤ì •
logging:
  level:
    root: INFO
    carsmartfactory: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    org.springframework.cloud: INFO
    org.springframework.security: DEBUG
    org.springframework.web: DEBUG
    org.springframework.cloud.stream: DEBUG  # Stream ë””ë²„ê¹… ì¶”ê°€
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# Management/Actuator ì„¤ì •
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
  info:
    env:
      enabled: true

---
# ========================================
# DOCKER PROFILE (ì»¨í…Œì´ë„ˆ í™˜ê²½)
# ========================================
spring:
  config:
    activate:
      on-profile: docker

  # PostgreSQL Docker ì—°ê²° ì„¤ì •
  datasource:
    url: jdbc:postgresql://postgres:5432/smartfactory
    username: postgres
    password: password
    driver-class-name: org.postgresql.Driver
    hikari:
      connection-timeout: 20000
      maximum-pool-size: 15
      minimum-idle: 5
      idle-timeout: 300000
      max-lifetime: 1200000

  # JPA ì„¤ì • (í”„ë¡œë•ì…˜)
  jpa:
    hibernate:
      ddl-auto: update
      naming:
        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
        implicit-strategy: org.hibernate.boot.model.naming.ImplicitNamingStrategyLegacyHbmImpl
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        show_sql: false
        format_sql: false
        jdbc:
          lob:
            non_contextual_creation: true
        temp:
          use_jdbc_metadata_defaults: false
    show-sql: false
    open-in-view: false

  # Kafka ì„¤ì • (Docker) - Spring Cloud Stream 4.x ë°©ì‹
  cloud:
    stream:
      # í•¨ìˆ˜í˜• ë°”ì¸ë”© ì„¤ì • - Docker í™˜ê²½
      function:
        definition: eventIn;rawDataOut;defectDataOut
      kafka:
        binder:
          brokers: kafka:9092
          auto-create-topics: true
        streams:
          binder:
            configuration:
              default:
                key:
                  serde: org.apache.kafka.common.serialization.Serdes$StringSerde
                value:
                  serde: org.apache.kafka.common.serialization.Serdes$StringSerde
      bindings:
        # ê¸°ì¡´ ë°”ì¸ë”©
        eventIn-in-0:
          destination: carsmartfactory
          group: pressdefectmonitoring
          contentType: application/json
        eventOut-out-0:
          destination: carsmartfactory
          contentType: application/json
          
        # ìƒˆë¡œìš´ í† í”½ë“¤
        rawDataOut-out-0:
          destination: raw-data-received
          contentType: application/json
        defectDataOut-out-0:
          destination: defect-data-detected
          contentType: application/json

# ì„œë²„ í¬íŠ¸ (Docker ë‚´ë¶€)
server:
  port: 8080

# ë¡œê¹… ì„¤ì • (í”„ë¡œë•ì…˜)
logging:
  level:
    root: WARN
    carsmartfactory: INFO
    org.hibernate: WARN
    org.springframework: WARN

---
# ========================================
# PRODUCTION PROFILE (Azure ë°°í¬í™˜ê²½)
# ========================================
spring:
  config:
    activate:
      on-profile: production

  # PostgreSQL Azure ì—°ê²° ì„¤ì •
  datasource:
    url: ${DATABASE_URL:jdbc:postgresql://azure-postgres:5432/smartfactory}
    username: ${DATABASE_USERNAME:postgres}
    password: ${DATABASE_PASSWORD:password}
    driver-class-name: org.postgresql.Driver
    hikari:
      connection-timeout: 30000
      maximum-pool-size: 20
      minimum-idle: 10
      idle-timeout: 600000
      max-lifetime: 1800000

  # JPA ì„¤ì • (í”„ë¡œë•ì…˜)
  jpa:
    hibernate:
      ddl-auto: update
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        show_sql: false
        format_sql: false
        jdbc:
          lob:
            non_contextual_creation: true
    show-sql: false
    open-in-view: false

  # Kafka ì„¤ì • (Azure) - Spring Cloud Stream 4.x ë°©ì‹
  cloud:
    stream:
      # í•¨ìˆ˜í˜• ë°”ì¸ë”© ì„¤ì • - Production í™˜ê²½
      function:
        definition: eventIn;rawDataOut;defectDataOut
      kafka:
        binder:
          brokers: ${KAFKA_BROKERS:azure-kafka:9092}
        streams:
          binder:
            configuration:
              default:
                key:
                  serde: org.apache.kafka.common.serialization.Serdes$StringSerde
                value:
                  serde: org.apache.kafka.common.serialization.Serdes$StringSerde
      bindings:
        # ê¸°ì¡´ ë°”ì¸ë”©
        eventIn-in-0:
          destination: carsmartfactory
          group: pressdefectmonitoring
          contentType: application/json
        eventOut-out-0:
          destination: carsmartfactory
          contentType: application/json
          
        # ìƒˆë¡œìš´ í† í”½ë“¤
        rawDataOut-out-0:
          destination: raw-data-received
          contentType: application/json
        defectDataOut-out-0:
          destination: defect-data-detected
          contentType: application/json

# ì„œë²„ ì„¤ì •
server:
  port: 8080

# ë¡œê¹… ì„¤ì • (í”„ë¡œë•ì…˜)
logging:
  level:
    root: ERROR
    carsmartfactory: WARN

# JWT ì„¤ì •
jwt:
  secret: ${JWT_SECRET:smartFactorySecretKeyForProductionEnvironmentUseOnly2024}
  expiration: 86400000  # 24ì‹œê°„

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •
app:
  security:
    jwt:
      secret-key: ${JWT_SECRET:smartFactorySecretKeyForProductionEnvironmentUseOnly2024}
      expiration-time: 86400000
  model-service:
    url: http://localhost:8003