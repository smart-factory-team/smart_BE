name: Smart BE Spring Boot MSA CI/CD Pipeline

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'usermanagement/**'
      - 'report/**'
      - 'approvalmanagement/**'
      - 'pressfaultdetection/**'
      - 'chatbot/**'
      - 'assemblyprocessmonitoring/**'
      - 'weldingprocessmonitoring/**'
      - 'gateway/**'
  push:
    branches: [ main ]
    paths:
      - 'usermanagement/**'
      - 'report/**'
      - 'approvalmanagement/**'
      - 'pressfaultdetection/**'
      - 'chatbot/**'
      - 'assemblyprocessmonitoring/**'
      - 'weldingprocessmonitoring/**'
      - 'gateway/**'

permissions:
  contents: read
  pull-requests: write
  checks: write
  actions: read
  packages: write
  id-token: write

env:
  REGISTRY: 23acr.azurecr.io
  AKS_CLUSTER_NAME: 23-aks
  AKS_RESOURCE_GROUP: 23-rsrc
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx1024m'
  NVD_API_KEY: ${{ secrets.NVD_API_KEY }}


jobs:
  # ë³€ê²½ëœ Spring Boot ì„œë¹„ìŠ¤ ê°ì§€
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changes.outputs.services }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      detection_method: ${{ steps.changes.outputs.detection_method }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed Spring Boot services
        id: changes
        run: |
          CHANGED_SERVICES=""
          DETECTION_METHOD=""
          
          # Spring Boot ì„œë¹„ìŠ¤ ëª©ë¡ ì •ì˜
          SPRING_SERVICES=("usermanagement" "report" "approvalmanagement" "pressfaultdetection" "chatbot" "assemblyprocessmonitoring" "weldingprocessmonitoring" "gateway")
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR ì œëª©ì—ì„œ ì„œë¹„ìŠ¤ëª… ì¶”ì¶œ
            PR_TITLE="${{ github.event.pull_request.title }}"
            SERVICE_NAME=$(echo "$PR_TITLE" | sed -n 's/^[^/]*\/[0-9]\+\/\([^:]*\):.*/\1/p' | sed 's/[[:space:]]*$//' | tr -cd '[:alnum:]-')
          
            echo "ğŸ” PR Title: $PR_TITLE"
            echo "ğŸ” Parsed Service: '$SERVICE_NAME'"
          
            # ì„œë¹„ìŠ¤ ë””ë ‰í† ë¦¬ í™•ì¸ (Spring Boot ì„œë¹„ìŠ¤ë§Œ)
            for svc in "${SPRING_SERVICES[@]}"; do
              if [ "$SERVICE_NAME" = "$svc" ] && [ -d "$svc" ]; then
                echo "âœ… Spring Boot service found: $svc"
                CHANGED_SERVICES="$svc"
                DETECTION_METHOD="pr_title"
                break
              fi
            done
          fi
          
          # PR ì œëª©ì—ì„œ ê°ì§€ ì‹¤íŒ¨í•˜ê±°ë‚˜ Push ì´ë²¤íŠ¸ì¸ ê²½ìš° git diff ì‚¬ìš©
          if [ -z "$CHANGED_SERVICES" ]; then
            echo "ğŸ” Using git diff to detect Spring Boot service changes..."
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              BASE_SHA="${{ github.event.pull_request.base.sha }}"
              HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            else
              BASE_SHA="${{ github.event.before }}"
              HEAD_SHA="${{ github.sha }}"
            fi
          
            # ë³€ê²½ëœ Spring Boot ì„œë¹„ìŠ¤ë§Œ í•„í„°ë§
            ALL_CHANGED=$(git diff --name-only $BASE_SHA $HEAD_SHA | cut -d'/' -f1 | sort -u)
          
            for changed_dir in $ALL_CHANGED; do
              for svc in "${SPRING_SERVICES[@]}"; do
                if [ "$changed_dir" = "$svc" ]; then
                  CHANGED_SERVICES="$CHANGED_SERVICES $svc"
                fi
              done
            done
          
            CHANGED_SERVICES=$(echo $CHANGED_SERVICES | tr ' ' '\n' | sort -u | tr '\n' ' ' | sed 's/ $//')
            DETECTION_METHOD="git_diff"
          
            if [ -z "$CHANGED_SERVICES" ]; then
              echo "ğŸ“­ No Spring Boot services changed"
            else
              echo "ğŸ“¦ Spring Boot services changed: $CHANGED_SERVICES"
            fi
          fi
          
          echo "services=$CHANGED_SERVICES" >> $GITHUB_OUTPUT
          echo "detection_method=$DETECTION_METHOD" >> $GITHUB_OUTPUT

      - name: Set matrix for changed services
        id: set-matrix
        run: |
          SERVICES="${{ steps.changes.outputs.services }}"
          if [ -z "$SERVICES" ]; then
            echo "matrix=[]" >> $GITHUB_OUTPUT
          else
            # JSON ë°°ì—´ í˜•íƒœë¡œ ë³€í™˜
            MATRIX_JSON=$(echo $SERVICES | tr ' ' '\n' | jq -R . | jq -s -c .)
            echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸ¯ Final matrix: $MATRIX_JSON"

  # ê° Spring Boot ì„œë¹„ìŠ¤ë³„ í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ
  test-and-build:
    needs: detect-changes
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Cache Maven dependenQcies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Check if service directory exists
        id: check-service
        run: |
          if [ -d "${{ matrix.service }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Service directory found: ${{ matrix.service }}"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Service directory ${{ matrix.service }} does not exist"
          fi

      - name: Run Maven tests - ${{ matrix.service }}
        id: test
        if: steps.check-service.outputs.exists == 'true'
        working-directory: ${{ matrix.service }}
        run: |
          echo "ğŸ§ª Running tests for ${{ matrix.service }}..."
          
          # Maven í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          mvn clean test -B -Dspring.profiles.active=test \
            -Dmaven.test.failure.ignore=true \
            -Dsurefire.useFile=false \
            -Dspring.datasource.url=jdbc:h2:mem:testdb \
            -Dspring.datasource.driver-class-name=org.h2.Driver \
            -Dspring.jpa.hibernate.ddl-auto=create-drop
          
          # í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì‹±
          if [ -f target/surefire-reports/TEST-*.xml ]; then
            TOTAL=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -h 'tests="[^"]*"' {} \; | grep -o '[0-9]*' | awk '{s+=$1} END {print s}' || echo "0")
            FAILURES=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -h 'failures="[^"]*"' {} \; | grep -o '[0-9]*' | awk '{s+=$1} END {print s}' || echo "0")
            ERRORS=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -h 'errors="[^"]*"' {} \; | grep -o '[0-9]*' | awk '{s+=$1} END {print s}' || echo "0")
            SKIPPED=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -h 'skipped="[^"]*"' {} \; | grep -o '[0-9]*' | awk '{s+=$1} END {print s}' || echo "0")
            PASSED=$((TOTAL - FAILURES - ERRORS))
          else
            TOTAL=0; PASSED=0; FAILURES=0; ERRORS=0; SKIPPED=0
          fi
          
          echo "total_tests=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed_tests=$PASSED" >> $GITHUB_OUTPUT
          echo "failed_tests=$((FAILURES + ERRORS))" >> $GITHUB_OUTPUT
          echo "skipped_tests=$SKIPPED" >> $GITHUB_OUTPUT
          echo "service_name=${{ matrix.service }}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Test Results: Total=$TOTAL, Passed=$PASSED, Failed=$((FAILURES + ERRORS)), Skipped=$SKIPPED"

      - name: Run Maven compile - ${{ matrix.service }}
        id: compile
        if: steps.check-service.outputs.exists == 'true'
        working-directory: ${{ matrix.service }}
        run: |
          echo "ğŸ”¨ Compiling ${{ matrix.service }}..."
          mvn clean compile -B -DskipTests
          
          if [ $? -eq 0 ]; then
            echo "compile_status=success" >> $GITHUB_OUTPUT
          else
            echo "compile_status=failure" >> $GITHUB_OUTPUT
          fi

      - name: Run Maven package (without tests) - ${{ matrix.service }}
        id: package
        if: steps.check-service.outputs.exists == 'true' && steps.compile.outputs.compile_status == 'success'
        working-directory: ${{ matrix.service }}
        run: |
          echo "ğŸ“¦ Packaging ${{ matrix.service }}..."
          mvn package -B -DskipTests
          
          if [ $? -eq 0 ]; then
            echo "package_status=success" >> $GITHUB_OUTPUT
            # JAR íŒŒì¼ ì •ë³´
            JAR_FILE=$(find target -name "*.jar" -not -name "*-sources.jar" | head -1)
            if [ -f "$JAR_FILE" ]; then
              JAR_SIZE=$(du -h "$JAR_FILE" | cut -f1)
              echo "jar_file=$JAR_FILE" >> $GITHUB_OUTPUT
              echo "jar_size=$JAR_SIZE" >> $GITHUB_OUTPUT
              echo "ğŸ“¦ Generated JAR: $JAR_FILE ($JAR_SIZE)"
            fi
          else
            echo "package_status=failure" >> $GITHUB_OUTPUT
          fi

      - name: Upload test results - ${{ matrix.service }}
        if: steps.check-service.outputs.exists == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.service }}
          path: |
            ${{ matrix.service }}/target/surefire-reports/
            ${{ matrix.service }}/target/*.jar
          retention-days: 7

  # ê° Spring Boot ì„œë¹„ìŠ¤ë³„ ë³´ì•ˆ ìŠ¤ìº”
  security-scan:
    needs: detect-changes
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Run OWASP Dependency Check - ${{ matrix.service }}
        id: security
        working-directory: ${{ matrix.service }}
        continue-on-error: true
        run: |
          echo "ğŸ”’ Running security scan for ${{ matrix.service }}..."
          
          # OWASP Dependency Check í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰
          mvn org.owasp:dependency-check-maven:check \
            -Dnvd.api.key=${NVD_API_KEY} \
            -DfailBuildOnCVSS=7 \
            -Dformat=JSON || true
          
          # ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ íŒŒì‹±
          if [ -f "target/dependency-check-report.json" ]; then
            HIGH=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity=="HIGH")] | length' target/dependency-check-report.json || echo "0")
            MEDIUM=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity=="MEDIUM")] | length' target/dependency-check-report.json || echo "0")
            LOW=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity=="LOW")] | length' target/dependency-check-report.json || echo "0")
            TOTAL=$((HIGH + MEDIUM + LOW))
          else
            HIGH=0; MEDIUM=0; LOW=0; TOTAL=0
          fi

          echo "high_issues=$HIGH" >> $GITHUB_OUTPUT
          echo "medium_issues=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low_issues=$LOW" >> $GITHUB_OUTPUT
          echo "total_issues=$TOTAL" >> $GITHUB_OUTPUT
          echo "service_name=${{ matrix.service }}" >> $GITHUB_OUTPUT
          
          echo "ğŸ”’ Security Results: High=$HIGH, Medium=$MEDIUM, Low=$LOW"

      - name: Upload security scan results - ${{ matrix.service }}
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-${{ matrix.service }}
          path: |
            ${{ matrix.service }}/target/dependency-check-report.*
          retention-days: 7

  # ê²°ê³¼ í†µí•©
  aggregate-results:
    needs: [ detect-changes, test-and-build, security-scan ]
    if: github.event_name == 'pull_request' && always() && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    outputs:
      total_tests: ${{ steps.aggregate.outputs.total_tests }}
      passed_tests: ${{ steps.aggregate.outputs.passed_tests }}
      failed_tests: ${{ steps.aggregate.outputs.failed_tests }}
      skipped_tests: ${{ steps.aggregate.outputs.skipped_tests }}
      compile_errors: ${{ steps.aggregate.outputs.compile_errors }}
      package_errors: ${{ steps.aggregate.outputs.package_errors }}
      high_issues: ${{ steps.aggregate.outputs.high_issues }}
      medium_issues: ${{ steps.aggregate.outputs.medium_issues }}
      low_issues: ${{ steps.aggregate.outputs.low_issues }}
      total_issues: ${{ steps.aggregate.outputs.total_issues }}
      failed_services: ${{ steps.aggregate.outputs.failed_services }}

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Aggregate results
        id: aggregate
        run: |
          # ëª¨ë“  ê²°ê³¼ í†µí•©
          TOTAL_TESTS=0
          PASSED_TESTS=0
          FAILED_TESTS=0
          SKIPPED_TESTS=0
          COMPILE_ERRORS=0
          PACKAGE_ERRORS=0
          TOTAL_HIGH=0
          TOTAL_MEDIUM=0
          TOTAL_LOW=0
          FAILED_SERVICES=""

          # ê° ì„œë¹„ìŠ¤ë³„ ê²°ê³¼ ì§‘ê³„
          for dir in test-results-*; do
            if [ -d "$dir" ]; then
              SERVICE_NAME=$(echo "$dir" | sed 's/test-results-//')
          
              # í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì‹±
              if find "$dir" -name "TEST-*.xml" -type f | head -1 | xargs test -f; then
                T=$(find "$dir" -name "TEST-*.xml" -exec grep -h 'tests="[^"]*"' {} \; | grep -o '[0-9]*' | awk '{s+=$1} END {print s}' || echo "0")
                F=$(find "$dir" -name "TEST-*.xml" -exec grep -h 'failures="[^"]*"' {} \; | grep -o '[0-9]*' | awk '{s+=$1} END {print s}' || echo "0")
                E=$(find "$dir" -name "TEST-*.xml" -exec grep -h 'errors="[^"]*"' {} \; | grep -o '[0-9]*' | awk '{s+=$1} END {print s}' || echo "0")
                S=$(find "$dir" -name "TEST-*.xml" -exec grep -h 'skipped="[^"]*"' {} \; | grep -o '[0-9]*' | awk '{s+=$1} END {print s}' || echo "0")

                TOTAL_TESTS=$((TOTAL_TESTS + T))
                FAILED_TESTS=$((FAILED_TESTS + F + E))
                SKIPPED_TESTS=$((SKIPPED_TESTS + S))
                PASSED_TESTS=$((PASSED_TESTS + T - F - E))

                # ì‹¤íŒ¨í•œ ì„œë¹„ìŠ¤ ì¶”ì 
                if [ $((F + E)) -gt 0 ]; then
                  FAILED_SERVICES="$FAILED_SERVICES,$SERVICE_NAME"
                fi
              fi
            fi
          done

          # ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ì§‘ê³„
          for dir in security-scan-*; do
            if [ -d "$dir" ] && [ -f "$dir/dependency-check-report.json" ]; then
              H=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity=="HIGH")] | length' "$dir/dependency-check-report.json" || echo "0")
              M=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity=="MEDIUM")] | length' "$dir/dependency-check-report.json" || echo "0")
              L=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity=="LOW")] | length' "$dir/dependency-check-report.json" || echo "0")

              TOTAL_HIGH=$((TOTAL_HIGH + H))
              TOTAL_MEDIUM=$((TOTAL_MEDIUM + M))
              TOTAL_LOW=$((TOTAL_LOW + L))
            fi
          done

          # Outputs ì„¤ì •
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "skipped_tests=$SKIPPED_TESTS" >> $GITHUB_OUTPUT
          echo "compile_errors=$COMPILE_ERRORS" >> $GITHUB_OUTPUT
          echo "package_errors=$PACKAGE_ERRORS" >> $GITHUB_OUTPUT
          echo "high_issues=$TOTAL_HIGH" >> $GITHUB_OUTPUT
          echo "medium_issues=$TOTAL_MEDIUM" >> $GITHUB_OUTPUT
          echo "low_issues=$TOTAL_LOW" >> $GITHUB_OUTPUT
          echo "total_issues=$((TOTAL_HIGH + TOTAL_MEDIUM + TOTAL_LOW))" >> $GITHUB_OUTPUT
          echo "failed_services=${FAILED_SERVICES#,}" >> $GITHUB_OUTPUT

  # ê° ì„œë¹„ìŠ¤ë³„ Docker ë¹Œë“œ ë° í‘¸ì‹œ (main ë¸Œëœì¹˜ë§Œ)
  build-and-push:
    needs: detect-changes
    if: github.ref == 'refs/heads/main' && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build JAR file - ${{ matrix.service }}
        working-directory: ${{ matrix.service }}
        run: |
          echo "ğŸ”¨ Building JAR for ${{ matrix.service }}..."
          mvn clean package -B -DskipTests
          
          # JAR íŒŒì¼ í™•ì¸
          JAR_FILE=$(find target -name "*.jar" -not -name "*-sources.jar" | head -1)
          if [ -f "$JAR_FILE" ]; then
            echo "âœ… JAR built successfully: $JAR_FILE"
          else
            echo "âŒ JAR build failed"
            exit 1
          fi

      - name: Check if Dockerfile exists for ${{ matrix.service }}
        id: dockerfile-check
        run: |
          if [ -f "${{ matrix.service }}/Dockerfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Dockerfile not found for ${{ matrix.service }}"
          fi

      - name: Login to Azure Container Registry
        if: steps.dockerfile-check.outputs.exists == 'true'
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push Docker image - ${{ matrix.service }}
        if: steps.dockerfile-check.outputs.exists == 'true'
        working-directory: ${{ matrix.service }}
        run: |
          IMAGE_NAME="smart-be-${{ matrix.service }}"
          
          echo "ğŸ³ Building Docker image for ${{ matrix.service }}..."
          docker build -t ${{ env.REGISTRY }}/${IMAGE_NAME}:${{ github.sha }} .
          docker build -t ${{ env.REGISTRY }}/${IMAGE_NAME}:latest .
          
          echo "ğŸ“¤ Pushing Docker image to ACR..."
          docker push ${{ env.REGISTRY }}/${IMAGE_NAME}:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${IMAGE_NAME}:latest
          
          echo "âœ… Built and pushed image: ${{ env.REGISTRY }}/${IMAGE_NAME}:${{ github.sha }}"

  # Pull Request ìë™ ë¦¬ë·°
  auto-review:
    needs: [ detect-changes, aggregate-results ]
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.services != '' && always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: PR Code Review Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const changedServices = "${{ needs.detect-changes.outputs.services }}".split(' ').filter(s => s.trim());

            if (changedServices.length === 0) {
              console.log('No Spring Boot services detected, skipping review comment');
              return;
            }

            try {
              const detectionMethod = "${{ needs.detect-changes.outputs.detection_method }}";
              const prTitle = "${{ github.event.pull_request.title }}";

              // ê° ì‘ì—…ì˜ ê²°ê³¼ ìˆ˜ì§‘
              const testResult = "${{ needs.test-and-build.result }}";
              const securityResult = "${{ needs.security-scan.result }}";

              // í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì‹±
              const testOutputs = {
                total: "${{ needs.aggregate-results.outputs.total_tests || '0' }}",
                passed: "${{ needs.aggregate-results.outputs.passed_tests || '0' }}",
                failed: "${{ needs.aggregate-results.outputs.failed_tests || '0' }}",
                skipped: "${{ needs.aggregate-results.outputs.skipped_tests || '0' }}",
                failedServices: "${{ needs.aggregate-results.outputs.failed_services || '' }}",
                compileErrors: "${{ needs.aggregate-results.outputs.compile_errors || '0' }}",
                packageErrors: "${{ needs.aggregate-results.outputs.package_errors || '0' }}"
              };

              // ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼
              const securityOutputs = {
                highIssues: "${{ needs.aggregate-results.outputs.high_issues || '0' }}",
                mediumIssues: "${{ needs.aggregate-results.outputs.medium_issues || '0' }}",
                lowIssues: "${{ needs.aggregate-results.outputs.low_issues || '0' }}",
                totalIssues: "${{ needs.aggregate-results.outputs.total_issues || '0' }}"
              };

              let reviewComment = "## ğŸ¤– Smart BE Spring Boot ìë™ ì½”ë“œ ë¦¬ë·°\n\n";
              reviewComment += `### ğŸ“¦ ë³€ê²½ëœ Spring Boot ì„œë¹„ìŠ¤ (${changedServices.length}ê°œ):\n`;

              changedServices.forEach(service => {
                reviewComment += `- **${service}** ì„œë¹„ìŠ¤\n`;
              });

              // ê°ì§€ ë°©ë²•ì— ë”°ë¥¸ ë©”ì‹œì§€
              if (detectionMethod === "pr_title") {
                reviewComment += "\nğŸ¯ **PR ì œëª©ì—ì„œ ì„œë¹„ìŠ¤ ìë™ ê°ì§€ë¨**\n";
                reviewComment += `- ì œëª©: \`${prTitle}\`\n`;
              } else if (detectionMethod === "git_diff") {
                reviewComment += "\nğŸ” **Git diffë¥¼ í†µí•´ ì„œë¹„ìŠ¤ ê°ì§€ë¨**\n";
              }

              // ì „ì²´ ìƒíƒœ ìš”ì•½
              reviewComment += "\n### ğŸ“Š ì „ì²´ ê²€ì‚¬ ê²°ê³¼:\n";
              const allPassed = testResult === 'success' && securityResult === 'success';

              if (allPassed) {
                reviewComment += "âœ… **ëª¨ë“  ê²€ì‚¬ í†µê³¼** - ë°°í¬ ì¤€ë¹„ ì™„ë£Œ!\n";
              } else {
                reviewComment += "âš ï¸ **ì¼ë¶€ ê²€ì‚¬ì—ì„œ ë¬¸ì œ ë°œê²¬** - í™•ì¸ í•„ìš”\n";
              }

              // ë¹Œë“œ & í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì„¹ì…˜
              reviewComment += "\n### ğŸ”¨ ë¹Œë“œ & í…ŒìŠ¤íŠ¸ ê²°ê³¼:\n";

              if (testResult === 'success') {
                reviewComment += "âœ… **ë¹Œë“œ & í…ŒìŠ¤íŠ¸ í†µê³¼**\n";
              } else if (testResult === 'failure') {
                reviewComment += "âŒ **ë¹Œë“œ & í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨**\n";
              } else {
                reviewComment += "âš ï¸ **ë¹Œë“œ & í…ŒìŠ¤íŠ¸ ìƒíƒœ ë¶ˆëª…**\n";
              }

              // í…ŒìŠ¤íŠ¸ í†µê³„
              if (testOutputs.total !== '0') {
                reviewComment += `- **ì´ í…ŒìŠ¤íŠ¸**: ${testOutputs.total}ê°œ\n`;
                reviewComment += `- **ì„±ê³µ**: ${testOutputs.passed}ê°œ âœ…\n`;

                if (testOutputs.failed !== '0') {
                  reviewComment += `- **ì‹¤íŒ¨**: ${testOutputs.failed}ê°œ âŒ\n`;
                }

                if (testOutputs.skipped !== '0') {
                  reviewComment += `- **ìŠ¤í‚µ**: ${testOutputs.skipped}ê°œ â­ï¸\n`;
                }
              }

              // ì‹¤íŒ¨í•œ ì„œë¹„ìŠ¤ ìƒì„¸ ì •ë³´
              if (testOutputs.failedServices) {
                reviewComment += "\n**ğŸ” ë¬¸ì œê°€ ìˆëŠ” ì„œë¹„ìŠ¤:**\n";
                const failedServicesList = testOutputs.failedServices.split(',').filter(s => s.trim());
                failedServicesList.forEach(service => {
                  reviewComment += `- \`${service.trim()}\`\n`;
                });
              }

              // ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ì„¹ì…˜
              reviewComment += "\n### ğŸ”’ ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼:\n";

              if (securityResult === 'success') {
                reviewComment += "âœ… **ë³´ì•ˆ ê²€ì‚¬ í†µê³¼**\n";
              } else if (securityResult === 'failure') {
                reviewComment += "âŒ **ë³´ì•ˆ ì´ìŠˆ ë°œê²¬**\n";
              } else {
                reviewComment += "âš ï¸ **ë³´ì•ˆ ìŠ¤ìº” ìƒíƒœ ë¶ˆëª…**\n";
              }

              if (securityOutputs.totalIssues !== '0') {
                reviewComment += `- **ì´ ë³´ì•ˆ ì´ìŠˆ**: ${securityOutputs.totalIssues}ê°œ\n`;

                if (securityOutputs.highIssues !== '0') {
                  reviewComment += `  - ğŸ”´ **High**: ${securityOutputs.highIssues}ê°œ\n`;
                }
                if (securityOutputs.mediumIssues !== '0') {
                  reviewComment += `  - ğŸŸ¡ **Medium**: ${securityOutputs.mediumIssues}ê°œ\n`;
                }
                if (securityOutputs.lowIssues !== '0') {
                  reviewComment += `  - ğŸŸ¢ **Low**: ${securityOutputs.lowIssues}ê°œ\n`;
                }
              } else {
                reviewComment += "- ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ âœ…\n";
              }

              // ì¢…í•© ì²´í¬ë¦¬ìŠ¤íŠ¸
              reviewComment += "\n### âœ… ê²€ì‚¬ ì²´í¬ë¦¬ìŠ¤íŠ¸:\n";
              reviewComment += testResult === 'success' ? 
                "- âœ… ë¹Œë“œ & í…ŒìŠ¤íŠ¸ í†µê³¼\n" : 
                "- âŒ ë¹Œë“œ & í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨\n";
              reviewComment += testOutputs.compileErrors === '0' ? 
                "- âœ… ì»´íŒŒì¼ ì„±ê³µ\n" : 
                "- âŒ ì»´íŒŒì¼ ì˜¤ë¥˜ ë°œê²¬\n";
              reviewComment += securityResult === 'success' ? 
                "- âœ… ë³´ì•ˆ ìŠ¤ìº” í†µê³¼\n" : 
                "- âŒ ë³´ì•ˆ ì´ìŠˆ ë°œê²¬\n";

              // ë°°í¬ ì •ë³´
              reviewComment += "\n### ğŸš€ ë°°í¬ ì •ë³´:\n";
              if (allPassed) {
                reviewComment += "- âœ… **ëª¨ë“  ê²€ì‚¬ í†µê³¼** - ë°°í¬ ì¤€ë¹„ ì™„ë£Œ\n";
                reviewComment += "- ğŸ”„ main ë¸Œëœì¹˜ ë¨¸ì§€ ì‹œ ìë™ ë°°í¬ë©ë‹ˆë‹¤\n";
                reviewComment += "- ğŸ—ï¸ ê° Spring Boot ì„œë¹„ìŠ¤ëŠ” ë…ë¦½ì ìœ¼ë¡œ ë¹Œë“œ/ë°°í¬ë©ë‹ˆë‹¤\n";
                reviewComment += "- ğŸ—„ï¸ ì„œë¹„ìŠ¤ë³„ ë…ë¦½ ë°ì´í„°ë² ì´ìŠ¤ê°€ ìƒì„±ë©ë‹ˆë‹¤\n";
              } else {
                reviewComment += "- âš ï¸ **ê²€ì‚¬ ì‹¤íŒ¨** - ë¬¸ì œ í•´ê²° í›„ ë°°í¬ ê°€ëŠ¥\n";
                if (testResult !== 'success') {
                  reviewComment += "  - ğŸ§ª ë¹Œë“œ/í…ŒìŠ¤íŠ¸ ë¬¸ì œ í•´ê²° í•„ìš”\n";
                }
                if (securityResult !== 'success') {
                  reviewComment += "  - ğŸ”’ ë³´ì•ˆ ì´ìŠˆ í•´ê²° í•„ìš”\n";
                }
              }
              reviewComment += "- ğŸ“‹ ìƒì„¸ ë¡œê·¸ëŠ” Actions íƒ­ì—ì„œ í™•ì¸ ê°€ëŠ¥\n";

              // Spring Boot íŠ¹í™” ì •ë³´
              reviewComment += "\n### â˜• Spring Boot ì„œë¹„ìŠ¤ ì •ë³´:\n";
              reviewComment += "- ğŸ—„ï¸ **ë°ì´í„°ë² ì´ìŠ¤**: ê° ì„œë¹„ìŠ¤ë³„ ë…ë¦½ PostgreSQL\n";
              reviewComment += "- ğŸ” **ì¸ì¦**: JWT ê¸°ë°˜ ë³´ì•ˆ\n";
              reviewComment += "- ğŸ“¨ **ë©”ì‹œì§•**: Kafka Stream ì—°ë™\n";
              reviewComment += "- ğŸ”§ **ì„¤ì •**: Profileë³„ í™˜ê²½ ë¶„ë¦¬ (default/docker/production)\n";
              reviewComment += "- ğŸ“Š **ëª¨ë‹ˆí„°ë§**: Actuator í—¬ìŠ¤ì²´í¬ ì œê³µ\n";

              // ê¸°ì¡´ ìë™ ë¦¬ë·° ì½”ë©˜íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì—…ë°ì´íŠ¸
              const { data: comments } = await github.rest.issues.listComments({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });

              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('ğŸ¤– Smart BE Spring Boot ìë™ ì½”ë“œ ë¦¬ë·°')
              );

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: reviewComment
                });
                console.log('Updated existing Spring Boot review comment');
              } else {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: reviewComment
                });
                console.log('Created new Spring Boot review comment');
              }

            } catch (error) {
              console.error('Error creating Spring Boot review comment:', error);
              process.exit(0);
            }

  # ê° ì„œë¹„ìŠ¤ë³„ AKS ë°°í¬
  deploy-to-aks:
    needs: [ detect-changes, build-and-push ]
    if: github.ref == 'refs/heads/main' && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials --resource-group ${{ env.AKS_RESOURCE_GROUP }} --name ${{ env.AKS_CLUSTER_NAME }}

      - name: Deploy Infrastructure (first service only)
        if: matrix.service == 'usermanagement'
        run: |
          echo "ğŸ—ï¸ Deploying infrastructure components for first service..."
          
          # 0) ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¶€í„° ë¨¼ì € ë³´ì¥ (ê°€ì¥ ì¤‘ìš”!)
          kubectl get ns smart-be >/dev/null 2>&1 || kubectl create ns smart-be
          
          # 1) Secrets ìƒì„± (ì´ì œ smart-beê°€ ìˆìœ¼ë¯€ë¡œ ì„±ê³µ)
          echo "ğŸ” Creating Kubernetes secrets..."
          kubectl create secret generic postgres-secret \
            --from-literal=username=${{ secrets.POSTGRES_USERNAME }} \
            --from-literal=password=${{ secrets.POSTGRES_PASSWORD }} \
            -n smart-be \
            --dry-run=client -o yaml | kubectl apply -f -
          
          kubectl create secret generic app-secrets \
            --from-literal=jwt-secret=${{ secrets.JWT_SECRET }} \
            -n smart-be \
            --dry-run=client -o yaml | kubectl apply -f -
          
          echo "âœ… Secrets created successfully!"
          
          # 2) PostgreSQL ë°°í¬ (ëª…ì‹œì ìœ¼ë¡œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì§€ì •)
          kubectl apply -n smart-be -f kubernetes/postgres-statefulset.yml
          
          # 4) PostgreSQL ì¤€ë¹„ ëŒ€ê¸°
          echo "â³ Waiting for PostgreSQL to be ready..."
          kubectl wait --for=condition=Ready pod -l app=postgres -n smart-be --timeout=300s      

          echo "âœ… Infrastructure deployment completed!"

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Deploy Spring Boot Service - ${{ matrix.service }}
        run: |
          echo "ğŸš€ Deploying ${{ matrix.service }} service..."
          
          # yqë¡œ í•´ë‹¹ ì„œë¹„ìŠ¤ë§Œ ì •í™•íˆ ì¶”ì¶œí•˜ê³  ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
          yq 'select(.kind=="Deployment" and .metadata.name=="${{ matrix.service }}") | (.spec.template.spec.containers[0].image |= sub("23acr.azurecr.io/smart-be-${{ matrix.service }}:latest", "${{ env.REGISTRY }}/smart-be-${{ matrix.service }}:${{ github.sha }}"))' \
            kubernetes/namespace.yml > temp-${{ matrix.service }}-deploy.yml
          
          yq 'select(.kind=="Service" and .metadata.name=="${{ matrix.service }}")' \
            kubernetes/namespace.yml > temp-${{ matrix.service }}-svc.yml
          
          # ëª…ì‹œì ìœ¼ë¡œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì§€ì •í•˜ì—¬ ì ìš©
          kubectl apply -n smart-be -f temp-${{ matrix.service }}-deploy.yml
          kubectl apply -n smart-be -f temp-${{ matrix.service }}-svc.yml
          
          # ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
          echo "â³ Waiting for ${{ matrix.service }} deployment to be ready..."
          kubectl rollout status deployment/${{ matrix.service }} -n smart-be --timeout=300s
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f temp-${{ matrix.service }}-deploy.yml temp-${{ matrix.service }}-svc.yml

      - name: Verify Deployment - ${{ matrix.service }}
        run: |
          echo "ğŸ” Verifying ${{ matrix.service }} deployment..."
          
          # Get pod status
          POD_STATUS=$(kubectl get pods -n smart-be -l app=${{ matrix.service }} -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "NotFound")
          echo "Pod Status: $POD_STATUS"
          
          # Get service info
          kubectl get service ${{ matrix.service }} -n smart-be || echo "Service not found"
          
          # Check logs if pod is not running
          if [ "$POD_STATUS" != "Running" ]; then
            echo "âŒ Pod is not running. Checking logs..."
            kubectl logs -l app=${{ matrix.service }} -n smart-be --tail=50 || echo "No logs available"
            kubectl describe pod -l app=${{ matrix.service }} -n smart-be || echo "No pods found"
          else
            echo "âœ… ${{ matrix.service }} is running successfully!"
          
            # Try to get service endpoint (if available)
            EXTERNAL_IP=$(kubectl get service ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
            if [ "$EXTERNAL_IP" != "pending" ] && [ ! -z "$EXTERNAL_IP" ]; then
              echo "ğŸŒ Service might be accessible at: http://$EXTERNAL_IP/actuator/health"
            else
              echo "ğŸ’¡ Use kubectl port-forward to test: kubectl port-forward -n smart-be svc/${{ matrix.service }} 8080:8080"
            fi
          fi